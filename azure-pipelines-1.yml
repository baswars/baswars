name: b15pipeline

trigger:
  branches:
    include:
      - main
      - master
    exclude:
      - feature*
  batch: true

pool:
  name: default
  demands:
    - Agent.Name -equals vm-agent

jobs:
# =========================
# Terraform Init / Plan Job
# =========================
- job: TerraformInitPlan
  displayName: Terraform Init & Plan
  steps:

  - task: TerraformInstaller@1
    displayName: Install Terraform
    inputs:
      terraformVersion: 'latest'

  - task: TerraformTask@5
    displayName: Terraform Init
    inputs:
      provider: azurerm
      command: init
      backendServiceArm: infra-ashoksc
      backendAzureRmResourceGroupName: rg-dev
      backendAzureRmStorageAccountName: devstoragedevaccount
      backendAzureRmContainerName: terraformcotainer
      backendAzureRmKey: terraformb15.tfstate

  - task: TerraformTask@5
    displayName: Terraform Validate
    inputs:
      provider: azurerm
      command: validate

  - task: TerraformTask@5
    displayName: Terraform Plan
    inputs:
      provider: azurerm
      command: plan
      environmentServiceNameAzureRM: infra-ashoksc

  # =========================
  # tfsec Scan
  # =========================
  - task: tfsec@1
    displayName: tfsec Terraform Scan
    inputs:
      version: v1.26.0
      dir: $(System.DefaultWorkingDirectory)

  # =========================
  # TFLint Install & Scan
  # =========================
  - task: PowerShell@2
    displayName: Install & Run TFLint
    inputs:
      targetType: inline
      script: |
        $ErrorActionPreference = "Stop"

        $url = "https://github.com/terraform-linters/tflint/releases/download/v0.54.0/tflint_windows_amd64.zip"
        $zipPath = "$(System.DefaultWorkingDirectory)\tflint.zip"
        $extractPath = "$(System.DefaultWorkingDirectory)\tflint"
        $tflintExe = "$extractPath\tflint.exe"

        Write-Host "Downloading TFLint..."
        Invoke-WebRequest -Uri $url -OutFile $zipPath

        Write-Host "Extracting TFLint..."
        Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force

        Write-Host "Verifying TFLint..."
        & $tflintExe --version

        Write-Host "Running TFLint (console output)..."
        & $tflintExe --init
        & $tflintExe

  # =========================
  # TFLint JUnit Report
  # =========================
  - task: CmdLine@2
    displayName: Run TFLint (JUnit Report)
    inputs:
      script: |
        echo Running TFLint with JUnit output...
        "$(System.DefaultWorkingDirectory)\tflint\tflint.exe" `
          --chdir "$(System.DefaultWorkingDirectory)" `
          --recursive `
          --format junit > "$(System.DefaultWorkingDirectory)\junit.xml"
      workingDirectory: '$(System.DefaultWorkingDirectory)'

  - task: PublishTestResults@2
    displayName: Publish TFLint Results
    condition: always()
    inputs:
      testResultsFormat: JUnit
      testResultsFiles: '$(System.DefaultWorkingDirectory)\junit.xml'
      mergeTestResults: true
      testRunTitle: TFLint Scan

# =========================
# Manual Approval Job
# =========================
- job: ManualValidate
  displayName: Manual Validation
  dependsOn: TerraformInitPlan
  pool: server
  timeoutInMinutes: 10
  steps:
  - task: ManualValidation@1
    inputs:
      notifyUsers: sachin.baswar@outlook.com
      approvers: sachin.baswar@outlook.com
      instructions: Please review Terraform plan and approve
